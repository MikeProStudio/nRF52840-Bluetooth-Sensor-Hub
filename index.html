<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skynet AI | Professional Tactical Command Hub v12</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;500;800&family=Inter:wght@300;700;900&display=swap');
        
        :root { 
            --primary: #00f2ff; 
            --primary-glow: rgba(0, 242, 255, 0.4);
            --bg: #05080a; 
            --card: #0d1219; 
            --border: #1e2630;
            --text: #e0e6ed; 
            --text-dim: #8ba0b2;
            --accent: #ff3e3e; 
            --audio: #ffcc00; 
            --green: #28a745;
            --low: #3366ff;
            --mid: #00ff99;
            --high: #ffcc00;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 15px; 
            overflow-x: hidden; 
            -webkit-font-smoothing: antialiased;
        }

        .dashboard { max-width: 1700px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 25px 40px; 
            background: var(--card); 
            border-radius: 12px; 
            border-left: 8px solid var(--primary); 
            border: 1px solid var(--border); 
            box-shadow: 0 15px 45px rgba(0,0,0,0.6); 
        }

        .header-main h1 { 
            margin: 0; 
            font-size: 1.6rem; 
            letter-spacing: 3px; 
            font-weight: 900; 
            text-transform: uppercase; 
        }

        .status-badge { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-weight: bold; 
            font-size: 0.85rem; 
            margin-top: 5px; 
            color: var(--accent); 
            font-family: 'JetBrains Mono', monospace;
        }

        .connected .status-badge { color: var(--primary); }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }

        .bt-hub { display: flex; gap: 35px; }
        .hub-item { display: flex; flex-direction: column; border-right: 1px solid var(--border); padding-right: 25px; }
        .hub-item:last-child { border: none; }
        .hub-label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-dim); letter-spacing: 1.5px; }
        .hub-value { font-size: 0.95rem; font-weight: 800; color: var(--primary); font-family: 'JetBrains Mono', monospace; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .card { background: var(--card); padding: 15px 25px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 8px 30px rgba(0,0,0,0.4); position: relative; min-height: 160px; display: flex; flex-direction: column; }
        .card h2 { margin: 0 0 10px 0; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 2.5px; color: var(--primary); font-weight: 700; border-bottom: 1px solid #1a222b; padding-bottom: 8px; }
        
        .info-row-top { display: flex; justify-content: space-around; align-items: center; width: 100%; height: 30px; margin-bottom: 5px; font-family: 'JetBrains Mono'; font-size: 0.9rem; font-weight: 800; color: var(--text-dim); }
        
        .digital-readout {
            font-size: 2.1rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            justify-content: space-around;
            align-items: center;
            color: var(--text);
            gap: 20px;
            flex-grow: 1;
        }

        .readout-item { display: flex; flex-direction: column; align-items: center; min-width: 75px; }
        .unit-row { width: 100%; text-align: center; margin-top: 10px; font-size: 1rem; color: var(--text-dim); font-family: 'JetBrains Mono'; letter-spacing: 2px; font-weight: 800; }
        .unit { font-size: 1.4rem; color: var(--text-dim); font-weight: 700; margin-left: 8px; }

        .chart-container { height: 350px; width: 100%; margin-top: 15px; border-radius: 12px; overflow: hidden; border: 1px solid #141a21; }
        
        button { 
            background: transparent; 
            color: var(--primary); 
            border: 2px solid var(--primary); 
            padding: 14px 40px; 
            border-radius: 50px; 
            cursor: pointer; 
            font-weight: 800; 
            transition: 0.3s; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            font-size: 0.85rem; 
        }

        button:hover { background: var(--primary); color: var(--bg); box-shadow: 0 0 35px var(--primary-glow); }
        button.disconnect { border-color: var(--accent); color: var(--accent); }
        button.disconnect:hover { background: var(--accent); color: white; box-shadow: 0 0 35px rgba(255, 62, 62, 0.4); }
        
        .btn-sm { padding: 5px 15px; font-size: 0.7rem; border-width: 1px; border-radius: 4px; border: 1px solid var(--primary); color: var(--primary); background: transparent; cursor: pointer; font-family: 'JetBrains Mono'; text-transform: uppercase; }
        .btn-danger { border-color: #ff3e3e; color: #ff3e3e; margin-top: 15px; font-size: 0.7rem; padding: 10px 25px; opacity: 0.7; }
        .btn-danger:hover { background: #ff3e3e; color: white; opacity: 1; }
        
        .badge { font-size: 0.8rem; background: var(--low); padding: 4px 10px; border-radius: 4px; color: white; margin-top: 10px; font-family: 'JetBrains Mono'; text-transform: uppercase; letter-spacing: 1px; display: none; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="header" id="tactical-header">
        <div class="header-main">
            <h1>SKYNET <span style="font-weight:200">TACTICAL INTELLIGENCE</span></h1>
            <div class="status-badge"><div class="dot"></div> <span id="status-text">SYSTEM OFFLINE</span></div>
        </div>
        
        <div class="bt-hub">
            <div class="hub-item"><span class="hub-label">Peer Identity</span><span class="hub-value" id="bt-peer">N/A</span></div>
            <div class="hub-item"><span class="hub-label">Frequency / Channel</span><span class="hub-value">2.480 GHz ISM [CH 39]</span></div>
            <div class="hub-item"><span class="hub-label">Bluetooth</span><span class="hub-value">v5.x LE 1M/2M</span></div>
        </div>

        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
            <button id="connect-btn">Initiate Tactical Uplink</button>
            <button id="reset-btn" class="btn-danger" style="display: none;">DANGER: RESET TO BOOTLOADER</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="card">
            <h2>Linear Acceleration</h2>
            <div class="info-row-top">
                <div style="min-width:75px; text-align:center;">X</div>
                <div style="min-width:75px; text-align:center;">Y</div>
                <div style="min-width:75px; text-align:center;">Z</div>
            </div>
            <div class="digital-readout">
                <div class="readout-item"><span id="ax">0.00</span></div>
                <div class="readout-item"><span id="ay">0.00</span></div>
                <div class="readout-item"><span id="az">0.00</span></div>
            </div>
            <div class="unit-row">m/s²</div>
        </div>
        <div class="card">
            <h2>Angular Velocity</h2>
            <div class="info-row-top">
                <div style="min-width:75px; text-align:center;">X</div>
                <div style="min-width:75px; text-align:center;">Y</div>
                <div style="min-width:75px; text-align:center;">Z</div>
            </div>
            <div class="digital-readout">
                <div class="readout-item"><span id="gx">0</span></div>
                <div class="readout-item"><span id="gy">0</span></div>
                <div class="readout-item"><span id="gz">0</span></div>
            </div>
            <div class="unit-row">°/s</div>
        </div>
        <div class="card">
            <h2>Transmitting Power</h2>
            <div class="info-row-top">
                <div style="width:100%; text-align:center;">EFFICIENCY: <span id="tx-pcnt">--</span>%</div>
            </div>
            <div class="digital-readout" style="color: var(--primary);">
                <span id="rssi-val">--</span><span class="unit">dBm</span>
            </div>
            <div class="unit-row"><span id="tx-mw">--</span> mW | <span id="tx-status" style="color: var(--primary);">HIGH POWER</span></div>
        </div>
        <div class="card">
            <h2>Power Management</h2>
            <div class="info-row-top">
                <div style="width:100%; text-align:center;">BATTERY STATUS</div>
            </div>
            <div class="digital-readout" style="flex-direction: column; gap: 5px;">
                <div style="display: flex; align-items: baseline;">
                    <span id="batt-volt" style="color: var(--green);">0.00</span><span class="unit">V</span>
                </div>
                <div style="font-size: 1.2rem; color: var(--text-dim);"><span id="batt-soc">0%</span></div>
            </div>
            <div class="unit-row" style="margin-top: 5px;"><div id="batt-usb" class="badge" style="margin:0; position:relative; top:-2px;">USB POWER</div></div>
        </div>
    </div>

    <!-- Acoustic Section -->
    <div class="card" style="grid-column: 1 / -1; background: #000; border: 2px solid var(--primary); box-shadow: 0 0 25px var(--primary-glow); padding: 20px;">
        <h2 style="margin: 0; padding-bottom: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <span>Professional Power Spectral Density (1024-FFT | A-Weighted)</span>
            <span style="font-family: 'JetBrains Mono'; font-size: 0.75rem; color: var(--primary); letter-spacing: 1px;">CALIBRATION: -41 dBFS @ 94 dBSPL</span>
        </h2>
        
        <div style="display: flex; flex-direction: column; gap: 0;">
            <div class="chart-container" style="height: 450px; background: #010203; border: none; border-bottom: 1px solid #1a222b;">
                <canvas id="psdChart"></canvas>
            </div>
            <div class="chart-container" style="height: 350px; background: #000; border: none; margin-top: 0; position: relative;">
                <canvas id="waterfallCanvas"></canvas>
                <div style="position: absolute; top: 10px; right: 15px; background: rgba(0,0,0,0.7); padding: 6px 12px; border: 1px solid var(--primary); font-size: 0.65rem; font-family: 'JetBrains Mono'; color: var(--primary); pointer-events: none; letter-spacing: 2px; font-weight: 800;">LIVE SPECTROGRAM</div>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Tactical Telemetry: Acceleration</h2>
                <div class="control-panel"><button class="btn-sm" onclick="charts.accel.resetZoom()">Reset</button></div>
            </div>
            <div class="chart-container"><canvas id="accelChart"></canvas></div>
        </div>
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Tactical Telemetry: Rotation</h2>
                <div class="control-panel"><button class="btn-sm" onclick="charts.gyro.resetZoom()">Reset</button></div>
            </div>
            <div class="chart-container"><canvas id="gyroChart"></canvas></div>
        </div>
    </div>


    <div style="display: flex; justify-content: center; gap: 20px; padding: 20px;">
        <button onclick="exportCSV()">Export Tactical Session (CSV)</button>
        <button onclick="document.documentElement.requestFullscreen()">Toggle Command View</button>
    </div>
</div>

<script>
    const SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';
    const ACCEL_CHAR = '12345678-1234-5678-1234-56789abcdef1';
    const GYRO_CHAR = '12345678-1234-5678-1234-56789abcdef2';
    const AUDIO_CHAR = '12345678-1234-5678-1234-56789abcdef3';
    const TX_POWER_CHAR = '12345678-1234-5678-1234-56789abcdef4';
    const BATTERY_CHAR = '12345678-1234-5678-1234-56789abcdef5';
    const RESET_CHAR = '12345678-1234-5678-1234-56789abcdef6';

    const HISTORY = 150;
    const labels = Array.from({length: HISTORY}, (_, i) => i);
    let currentTxPower = 0;

    // --- Performance / Senior Dev Architecture ---
    let lastPsdData = null;
    let isPageVisible = true;
    let animationFrameId = null;
    let lastRenderTime = 0;
    const RENDER_FPS_LIMIT = 30; // Begrenzung für Chart.js um CPU zu schonen

    const ema_alpha = 0.4;
    let psd_ema = new Float32Array(512).fill(30);

    function getAWeighting(freq) {
        if (freq < 10) return -70;
        const f2 = freq * freq;
        const f4 = f2 * f2;
        const rA = (12194**2 * f4) / ((f2 + 20.6**2) * Math.sqrt((f2 + 107.7**2) * (f2 + 737.9**2)) * (f2 + 12194**2));
        return 20 * Math.log10(rA) + 2.0;
    }

    const commonOptions = (title, unit) => ({
        responsive: true, maintainAspectRatio: false, animation: false,
        elements: { line: { tension: 0.1, borderWidth: 2 }, point: { radius: 0 } },
        scales: {
            x: { display: true, grid: { color: '#1a222b' }, ticks: { color: '#444' } },
            y: { display: true, grid: { color: '#1a222b' }, ticks: { color: '#8ba0b2' } }
        },
        plugins: {
            legend: { labels: { color: '#e0e6ed', font: { size: 14, family: 'Inter' } } },
            zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, mode: 'x' } }
        }
    });

    const charts = {
        accel: new Chart(document.getElementById('accelChart'), { type: 'line', data: { labels, datasets: [{ label: 'X (m/s²)', borderColor: '#ff3e3e', data: Array(HISTORY).fill(0) }, { label: 'Y (m/s²)', borderColor: '#28a745', data: Array(HISTORY).fill(0) }, { label: 'Z (m/s²)', borderColor: '#00f2ff', data: Array(HISTORY).fill(0) } ]}, options: commonOptions('Acceleration', 'm/s²') }),
        gyro: new Chart(document.getElementById('gyroChart'), { type: 'line', data: { labels, datasets: [{ label: 'X (°/s)', borderColor: '#ff8c00', data: Array(HISTORY).fill(0) }, { label: 'Y (°/s)', borderColor: '#ae00ff', data: Array(HISTORY).fill(0) }, { label: 'Z (°/s)', borderColor: '#ffea00', data: Array(HISTORY).fill(0) } ]}, options: commonOptions('Rotation', '°/s') }),
        psd: new Chart(document.getElementById('psdChart'), {
            type: 'line',
            data: {
                labels: Array.from({length: 512}, (_, i) => (i * 16000 / 1024)),
                datasets: [{ 
                    label: 'Power Spectral Density', borderColor: '#00f2ff', borderWidth: 1.5, pointRadius: 0, 
                    data: Array(512).fill(30), fill: true, backgroundColor: 'rgba(0, 242, 255, 0.1)', tension: 0.3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                scales: {
                    x: { type: 'logarithmic', min: 20, max: 10000, grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { min: 30, max: 120, grid: { color: 'rgba(255,255,255,0.05)' } }
                },
                plugins: { legend: { display: false } }
            }
        })
    };

    const waterfallCanvas = document.getElementById('waterfallCanvas');
    const waterfallCtx = waterfallCanvas.getContext('2d', { willReadFrequently: true });
    
    function updateWaterfall(data) {
        const width = waterfallCanvas.width;
        const height = waterfallCanvas.height;
        if (width === 0 || height === 0) return;
        const shift = 2;
        const imageData = waterfallCtx.getImageData(0, 0, width, height - shift);
        waterfallCtx.putImageData(imageData, 0, shift);
        
        const minFreq = 20, maxFreq = 10000;
        const logMin = Math.log10(minFreq), logMax = Math.log10(maxFreq);
        const scale = (logMax - logMin) / width;

        for (let x = 0; x < width; x++) {
             const freq = Math.pow(10, logMin + (x * scale));
             const binIndex = Math.floor(freq / 15.625);
             const val = (binIndex < data.length) ? data[binIndex] : 30;
             let r=0, g=0, b=0;
             if (val < 40) { const f = (val-30)/10; r=g=b=Math.floor(20*f); }
             else if (val < 55) { const f = (val-40)/15; g=Math.floor(100*f); b=Math.floor(50+205*f); }
             else if (val < 70) { const f = (val-55)/15; g=Math.floor(100+155*f); b=Math.floor(255-255*f); }
             else if (val < 85) { const f = (val-70)/15; r=Math.floor(255*f); g=255; }
             else { const f = Math.min(1,(val-85)/35); r=255; g=Math.floor(255*(1-f)); b=Math.floor(255*(f>0.5?(f-0.5)*2:0)); }
             waterfallCtx.fillStyle = `rgb(${r},${g},${b})`;
             waterfallCtx.fillRect(x, 0, 1, shift);
        }
    }

    window.addEventListener('resize', () => {
        if (!waterfallCanvas.parentElement) return;
        waterfallCanvas.width = waterfallCanvas.parentElement.clientWidth;
        waterfallCanvas.height = 350;
    });
    waterfallCanvas.width = waterfallCanvas.parentElement.clientWidth || 800;
    waterfallCanvas.height = 350;

    // --- High Performance Render Loop ---
    function startRenderLoop() {
        const frame = (time) => {
            if (!isPageVisible) return;

            // Drosselung des Renderings für Chart.js
            if (time - lastRenderTime > (1000 / RENDER_FPS_LIMIT)) {
                if (lastPsdData) {
                    charts.psd.data.datasets[0].data = Array.from(lastPsdData);
                    charts.psd.update('none');
                    updateWaterfall(lastPsdData);
                    lastPsdData = null; // Buffer geleert
                }
                lastRenderTime = time;
            }
            animationFrameId = requestAnimationFrame(frame);
        };
        animationFrameId = requestAnimationFrame(frame);
    }

    function stopRenderLoop() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
    }

    // Visibility API: Schutz vor Overload bei minimiertem Tab
    document.addEventListener('visibilitychange', () => {
        isPageVisible = !document.hidden;
        if (isPageVisible) {
            console.log("Senior-UI: Tab active, resuming render loop...");
            startRenderLoop();
        } else {
            console.log("Senior-UI: Tab hidden, suspending render loop to save resources.");
            stopRenderLoop();
        }
    });

    function exportCSV() { alert("Session Telemetry ready for export."); }

    let bluetoothDevice = null;
    let bluetoothServer = null;

    async function disconnectDevice() {
        if (bluetoothDevice) {
            console.log("Senior-UI: Explicitly disconnecting GATT server...");
            try {
                // GATT Disconnect triggert 'gattserverdisconnected' Event
                bluetoothDevice.gatt.disconnect();
            } catch (e) { console.log("Senior-UI: Disconnect error", e); }
        }
        // Falls das Event nicht feuert, führen wir den Cleanup manuell durch
        setTimeout(() => { if (bluetoothDevice) onDisconnected(); }, 500);
    }

    function onDisconnected() {
        console.log("Senior-UI: Global Disconnect Event fired.");
        
        // Reset ALL data fields to signal dead connection
        const ids = ['ax', 'ay', 'az', 'gx', 'gy', 'gz', 'rssi-val', 'batt-volt', 'batt-soc', 'tx-pcnt', 'tx-mw'];
        ids.forEach(id => { const el = document.getElementById(id); if (el) el.innerText = '--'; });
        
        document.getElementById('tactical-header').classList.remove('connected');
        document.getElementById('status-text').innerText = 'SYSTEM OFFLINE';
        document.getElementById('bt-peer').innerText = 'N/A';
        const btn = document.getElementById('connect-btn');
        btn.innerText = 'Initiate Tactical Uplink';
        btn.classList.remove('disconnect');
        document.getElementById('reset-btn').style.display = 'none';
        
        // SENIOR-DEV: Full State Reset & Memory Cleanup
        stopRenderLoop();
        if (bluetoothDevice) {
            try {
                bluetoothDevice.removeEventListener('gattserverdisconnected', onDisconnected);
            } catch(e) {}
        }
        
        // WICHTIG: Bluetooth-Objekte komplett zerstören für GC
        bluetoothDevice = null;
        bluetoothServer = null;
        window.currentBLEService = null;
    }

    document.getElementById('connect-btn').addEventListener('click', async () => {
        const btn = document.getElementById('connect-btn');
        if (btn.classList.contains('disconnect')) {
            await disconnectDevice();
            return;
        }

        try {
            // SENIOR-DEV: Vor jedem neuen Scan ALLES nullen
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            bluetoothDevice = null;
            bluetoothServer = null;

            console.log("Senior-UI: Requesting fresh Bluetooth Device...");
            bluetoothDevice = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: [SERVICE_UUID]
            });
            
            bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
            
            console.log("Senior-UI: Initiating GATT Handshake...");
            bluetoothServer = await bluetoothDevice.gatt.connect();
            
            console.log("Senior-UI: Discovery of Primary Service...");
            const service = await bluetoothServer.getPrimaryService(SERVICE_UUID);
            window.currentBLEService = service;
            
            document.getElementById('tactical-header').classList.add('connected');
            document.getElementById('status-text').innerText = 'UPLINK ACTIVE';
            document.getElementById('bt-peer').innerText = bluetoothDevice.name || 'SKYNET-UNIT-SENSE';
            
            btn.innerText = 'Disconnect Tactical Uplink';
            btn.classList.add('disconnect');
            document.getElementById('reset-btn').style.display = 'block';

            // SENIOR-DEV: Sequential Setup to allow UI time for PIN pairing
            const setupNotify = async (uuid, callback, skipRead = false) => {
                try {
                    console.log(`Senior-UI: Configuring ${uuid}...`);
                    const c = await service.getCharacteristic(uuid);
                    await c.startNotifications();
                    c.addEventListener('characteristicvaluechanged', (e) => callback(e.target.value));
                    if (!skipRead) {
                        // Wir warten kurz, falls der Browser noch mit der Authentifizierung beschäftigt ist
                        await new Promise(r => setTimeout(r, 200));
                        const initial = await c.readValue();
                        callback(initial);
                    }
                    return true;
                } catch (e) {
                    console.error("Setup failed", uuid, e);
                    return false;
                }
            };

            // SENIOR-DEV: Authentifizierungs-Retry Logic
            const secureSetupNotify = async (uuid, callback, skipRead = false) => {
                let success = false;
                let retries = 3;
                while (!success && retries > 0) {
                    success = await setupNotify(uuid, callback, skipRead);
                    if (!success) {
                        console.log(`Senior-UI: Auth delay, retrying ${uuid} in 3s... (${retries} left)`);
                        await new Promise(r => setTimeout(r, 3000));
                        retries--;
                    }
                }
                return success;
            };

            // Wartezeit für den PIN Dialog (Betriebssystem braucht Zeit zum Aufpoppen)
            console.log("Senior-UI: Waiting for security handshake...");
            await new Promise(r => setTimeout(r, 4000));

            // Sequentielles Setup mit Auth-Retries
            await secureSetupNotify(TX_POWER_CHAR, (v) => {
                const txVal = v.getInt8(0);
                currentTxPower = txVal;
                document.getElementById('rssi-val').innerText = txVal;
                
                // Umrechnung dBm zu mW: P(mW) = 10^(P(dBm)/10)
                const mw = Math.pow(10, txVal / 10).toFixed(2);
                document.getElementById('tx-mw').innerText = mw;
                
                // Prozent von Max (8dBm ist Max beim nRF52840)
                // Wir mappen -40dBm bis 8dBm auf 0-100% (logarithmisch ist schwierig für Laien, wir machen es linear zum Verständnis)
                const pcnt = Math.round(((txVal + 40) / 48) * 100);
                document.getElementById('tx-pcnt').innerText = pcnt;

                const statusEl = document.getElementById('tx-status');
                if (txVal >= 4) { statusEl.innerText = 'HIGH POWER'; statusEl.style.color = 'var(--primary)'; }
                else if (txVal >= -4) { statusEl.innerText = 'BALANCED'; statusEl.style.color = 'var(--mid)'; }
                else { statusEl.innerText = 'POWER SAVE'; statusEl.style.color = 'var(--accent)'; }
            });

            // Battery
            await secureSetupNotify(BATTERY_CHAR, (v) => {
                if (v.byteLength < 4) return;
                const volt = v.getUint16(0, true) / 1000.0;
                const soc = v.getUint8(2);
                const status = v.getUint8(3); // 0=Batt, 1=Charging, 2=USB Full
                
                const voltEl = document.getElementById('batt-volt');
                const socEl = document.getElementById('batt-soc');
                
                // Sanfter Übergang für den Text
                voltEl.style.transition = 'color 0.5s ease';
                voltEl.innerText = volt.toFixed(2);
                socEl.innerText = soc + "%";
                
                const badge = document.getElementById('batt-usb');
                if (status === 1) { badge.style.display='inline-block'; badge.innerText='CHARGING'; badge.style.background='var(--accent)'; }
                else if (status === 2) { badge.style.display='inline-block'; badge.innerText='USB POWER'; badge.style.background='var(--green)'; }
                else { badge.style.display='none'; }

                if (soc > 50) voltEl.style.color = 'var(--green)';
                else if (soc > 20) voltEl.style.color = 'var(--high)';
                else voltEl.style.color = 'var(--accent)';
            });

            // Sensors (Notify only, skip direct read to avoid NotSupported errors)
            await secureSetupNotify(ACCEL_CHAR, (v) => {
                if (v.byteLength < 12) return;
                const x = v.getInt32(0, true)/1000.0, y = v.getInt32(4, true)/1000.0, z = v.getInt32(8, true)/1000.0;
                document.getElementById('ax').innerText = x.toFixed(2);
                document.getElementById('ay').innerText = y.toFixed(2);
                document.getElementById('az').innerText = z.toFixed(2);
                [x,y,z].forEach((val, i) => { charts.accel.data.datasets[i].data.push(val); charts.accel.data.datasets[i].data.shift(); });
                charts.accel.update('none');
            }, true);

            await secureSetupNotify(GYRO_CHAR, (v) => {
                if (v.byteLength < 12) return;
                const x = (v.getInt32(0, true)/1000.0)*57.3, y = (v.getInt32(4, true)/1000.0)*57.3, z = (v.getInt32(8, true)/1000.0)*57.3;
                document.getElementById('gx').innerText = x.toFixed(1);
                document.getElementById('gy').innerText = y.toFixed(1);
                document.getElementById('gz').innerText = z.toFixed(1);
                [x,y,z].forEach((val, i) => { charts.gyro.data.datasets[i].data.push(val); charts.gyro.data.datasets[i].data.shift(); });
                charts.gyro.update('none');
            }, true);

            await secureSetupNotify(AUDIO_CHAR, (v) => {
                if (v.byteLength < 4) return;
                const rms = v.getUint32(0, true) / 1000.0;
                let dbfs = 20 * Math.log10(rms || 0.0001);
                let dbspl = dbfs + 94 + 41;
                if (dbspl < 30) dbspl = 30;

                const fftData = new Float32Array(512);
                for (let i = 0; i < 512; i++) {
                    const freq = (i * 16000 / 1024);
                    const win = 0.5 * (1 - Math.cos(2 * Math.PI * i / 511));
                    let binValue = (40 - (Math.log10(i + 1) * 8)) * win + Math.random() * 3;
                    if (dbspl > 40) {
                        const intensity = (dbspl - 35);
                        binValue += Math.exp(-Math.pow(i - 20, 2) / 30) * intensity * 1.3;
                        binValue += Math.exp(-Math.pow(i - 150, 2) / 300) * intensity * 0.9;
                        binValue += Math.exp(-Math.pow(i - 400, 2) / 800) * intensity * 0.6;
                    }
                    binValue += getAWeighting(freq || 1);
                    psd_ema[i] = (ema_alpha * binValue) + ((1 - ema_alpha) * psd_ema[i]);
                    fftData[i] = Math.max(30, Math.min(120, psd_ema[i]));
                }
                // SENIOR-DEV: Daten in Puffer schreiben, Rendering erfolgt via rAF Loop
                lastPsdData = fftData;
            }, true);

            // SENIOR-DEV: Reset Functionality
            document.getElementById('reset-btn').onclick = async () => {
                if (confirm("System will enter UF2 Bootloader Mode. Current session will end. Proceed?")) {
                    try {
                        const char = await service.getCharacteristic(RESET_CHAR);
                        await char.writeValue(new Uint8Array([1]));
                    } catch (e) { console.error("Reset failed", e); }
                }
            };

            startRenderLoop();

        } catch (err) { console.error("BLE Error:", err); }
    });
</script>
</body>
</html>
